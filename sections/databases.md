# Конспекты по базам данных
## SQL Databases
### Индексы в базах данных

Не стоит забывать, что индексы не только ускоряют скорость поиска, но и позволяют уменьшить алгоритмическую
сложность этого процесса.

Например, алгоритмическая сложность поиск числа в отсортированном списке методом перебора составляет O(n),
а методом бинарного поиска - O(log(n)). Это означает следующий рост количества операций при возрастании количества
записей:
![image](https://tproger.ru/s3/uploads/2021/02/table1.png)
Принцип работы В-дерева основан также на методе бинарного поиска.

Индексы могут быть *простые* и *составные*. Простые индексы создаются по одному полю, составные индексы могут
состоять из нескольких полей:
```sql
CREATE INDEX index_name
ON table_name (column_name_1, column_name_2,....)
```
У данной операции большое количество параметров, например, можно сделать индекс который будет следить за
уникальностью по нескольким полям, в таком случае в таблице не появятся строки, у которых полностью совпадают
значения сразу в нескольких полях.
```sql
CREATE UNIQUE INDEX index_name
ON table_name (column_name_1, column_name_2,....)
```
Также мы можем создать индекс по функции или скалярному выражению, они так и называются *функциональными* или
*скалярными*. Такие индексы позволяют находить данные в таблице по результатам вычислений.
```sql
CREATE INDEX index_name ON table_name(lower(text_field))
```
Данный индекс позволит быстрее осуществить поиск по запросу:
```sql
SELECT * FROM table_name
WHERE lower(text_field) = 'some_string_in_lower_case'
```
---
### B-tree

Данный тип индекса используется по умолчанию и покрывает большинство задач. Практически любой запрос, условие которого
является выражением, состоящим из полей входящих в индекс, логических операторов и операций равенства/сравнения.

Найти пользователя по e-mail:
```sql
SELECT * FROM users WHERE email='user@mail.com'
```
Найти товары одной из двух категорий:
```sql
SELECT * FROM goods WHERE category_id = 10 OR category_id = 20
```
Найти количество пользователей, зарегистрировавшихся в конкретный месяц:
```sql
SELECT COUNT(id) FROM users WHERE reg_date >= 01.01.2021 AND reg_date <= 31.01.2021
```
Кроме того, индекс на основе В-дерева позволяет ускорить сортировку результатов, если сортировка производиться
по проиндексированному полю.

Принцип работы В-дерева построен на алгоритме бинарного поиска, так, индекс хранится в виде сбалансированного
сильно ветвящегося дерева, называемого B-tree.
![image](https://tproger.ru/s3/uploads/2021/02/tree.png)
Корневой узел дерева содержит несколько промежуточных значений, тогда следующие поддеревья делят элементы
по следующему принципу:
1. в промежутке от 1 до 30 элемента
2. в промежутке от 30 до 70
3. в промежутке от 70 до 97

Каждое поддерево является тоже В-деревом, имеет корневой элемент и строится далее рекурсивно по такому же принципу.

При поиске в В-дереве необходимо максимум h раз произвести линейный или бинарный поиск в относительно
небольших списках. Каждый узел обычно хранит такой объем данных, который можно прочитать или записать за одну операцию 
ввода — вывода. В случае если бинарное дерево целиком не помещается в оперативную память СУБД может держать только 
верхние уровни дерева в памяти, читая узлы нижних уровней только при необходимости.

В том случае, если индекс построен по нескольким колонкам, он будет ускорять поиск только запросы где фигурируют 
одна или несколько первых колонок. Например индекс созданные для col_1, col_2 ускорит следующий запрос:
```sql
SELECT * FROM table_name WHERE col_1 = 123
```
Однако, для поиска только по col_2 данный индекс использоваться не будет.

###GIST
Generalized search tree - это сбалансированное дерево поиска, точно такое же как b-tree. Но данное дерево 
позволяет индексировать данные, для которых операция упорядочивания не имеет смысла. 

##RabbitMQ
Брокер работает по протоколу AMQP(Advanced Message Queueing Protocol), на его самом нижнем уровне используется
протокол TCP, выше лежит формат RPC-запросов между клиентом и сервисом. Сама семантика работы с сообщениями,
создания очередей, описывается в XML спецификации.

Протокол AMQP основан на следующих понятиях:
- Сообщение - единица передаваемых данных, основная его часть никак не интерпритируется сервером
- Точка обмена - в нее отправляются сообщения
- Очередь - здесь хранятся сообщения до тех пор, пока не будут забраны клиентом
